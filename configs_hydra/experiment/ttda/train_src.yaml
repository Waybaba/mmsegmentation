# @package _global_

defaults:
  - override /model: segformer_b0.yaml
  - override /dataset: gta2cityscapes.yaml
  - _self_

#! not finished yet

### global_cfg
crop_size_list_: ??? # [512, 512] or [1024, 1024]
stride_list_: ???
gta_scale_list_: ???
crop_size:
  _args_:
  - ${crop_size_list_} # e.g. [1024, 1024]
  _target_: builtins.tuple
test_scale:
  _args_:
  - [1024, 512]
  _target_: builtins.tuple
gta_scale:
  _args_:
  - ${gta_scale_list_} # [1280, 720] if crop_size==[512, 512], [2560, 1440] if crop_size==[1024, 1024]
  _target_: builtins.tuple


default_hooks:
  checkpoint:
    by_epoch: false
    interval: 16000
    type: CheckpointHook
  logger:
    interval: 50
    log_metric_by_epoch: false
    type: LoggerHook
  param_scheduler:
    type: ParamSchedulerHook
  sampler_seed:
    type: DistSamplerSeedHook
  timer:
    type: IterTimerHook
  visualization:
    type: SegVisualizationHook

custom_hooks:
  # - ${ttda_hook} # ! change ttda_hook.xxx so that could be logged in wandb
  - type: TTDABeforeRunInitHook

dataset: 
  train_dataloader: # ! to dataset?
    batch_size: 1
    num_workers: 4
  val_dataloader:
    batch_size: 1
    num_workers: 4
  test_dataloader:
    batch_size: 1
    num_workers: 4

param_scheduler:
  - begin: 0
    by_epoch: false
    end: 160000
    eta_min: 0.0001
    power: 0.9
    type: PolyLR

optim_wrapper:
  # _delete_: true
  ### ! SGD
  # optimizer:
  #   lr: 6.0e-05
  #   type: SGD
  #   weight_decay: 1e-4
  #   momentum: 0.9
  ### ! Adam
  optimizer:
    betas:
      _args_:
      - [0.9, 0.999]
      _target_: builtins.tuple
    lr: 6.0e-05
    type: AdamW
    weight_decay: 0.01
  paramwise_cfg:
    custom_keys:
      head:
        lr_mult: 10.0
      norm:
        decay_mult: 0.0
      pos_block:
        decay_mult: 0.0
  type: OptimWrapper





test_cfg:
  type: TestLoop
train_cfg:
  max_iters: 160000
  type: IterBasedTrainLoop
  val_interval: 16000
val_cfg:
  type: ValLoop


## runtime
default_scope: mmseg
env_cfg:
  cudnn_benchmark: true
  dist_cfg:
    backend: nccl
  mp_cfg:
    mp_start_method: fork
    opencv_num_threads: 0
load_from: ???
log_level: INFO
log_processor:
  by_epoch: false
resume: false
tta_model:
  type: SegTTAModel
visualizer:
  name: visualizer
  type: SegLocalVisualizer
  vis_backends:
  - type: LocalVisBackend
  - init_kwargs:
      mode: ${wandb.mode}
      project: ${task_name}
      entity: ${oc.env:WANDB_ENTITY}
      tags: ${tags}
    type: WandbVisBackend
